{"dependencies":[{"name":"../actions/public/getTransactionCount.js","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":6,"column":33,"index":217},"end":{"line":6,"column":84,"index":268}}],"key":"5aO3LDyeI03lFD1AB76JowmLAkM=","exportNames":["*"],"imports":1}},{"name":"./lru.js","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":7,"column":17,"index":287},"end":{"line":7,"column":36,"index":306}}],"key":"4TUh40wRT4OKFeeXa1AkcQdSx1c=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.nonceManager = void 0;\n  exports.createNonceManager = createNonceManager;\n  exports.jsonRpc = jsonRpc;\n  const getTransactionCount_js_1 = require(_dependencyMap[0], \"../actions/public/getTransactionCount.js\");\n  const lru_js_1 = require(_dependencyMap[1], \"./lru.js\");\n  function createNonceManager(parameters) {\n    const {\n      source\n    } = parameters;\n    const deltaMap = new Map();\n    const nonceMap = new lru_js_1.LruMap(8192);\n    const promiseMap = new Map();\n    const getKey = ({\n      address,\n      chainId\n    }) => `${address}.${chainId}`;\n    return {\n      async consume({\n        address,\n        chainId,\n        client\n      }) {\n        const key = getKey({\n          address,\n          chainId\n        });\n        const promise = this.get({\n          address,\n          chainId,\n          client\n        });\n        this.increment({\n          address,\n          chainId\n        });\n        const nonce = await promise;\n        await source.set({\n          address,\n          chainId\n        }, nonce);\n        nonceMap.set(key, nonce);\n        return nonce;\n      },\n      async increment({\n        address,\n        chainId\n      }) {\n        const key = getKey({\n          address,\n          chainId\n        });\n        const delta = deltaMap.get(key) ?? 0;\n        deltaMap.set(key, delta + 1);\n      },\n      async get({\n        address,\n        chainId,\n        client\n      }) {\n        const key = getKey({\n          address,\n          chainId\n        });\n        let promise = promiseMap.get(key);\n        if (!promise) {\n          promise = (async () => {\n            try {\n              const nonce = await source.get({\n                address,\n                chainId,\n                client\n              });\n              const previousNonce = nonceMap.get(key) ?? 0;\n              if (previousNonce > 0 && nonce <= previousNonce) return previousNonce + 1;\n              nonceMap.delete(key);\n              return nonce;\n            } finally {\n              this.reset({\n                address,\n                chainId\n              });\n            }\n          })();\n          promiseMap.set(key, promise);\n        }\n        const delta = deltaMap.get(key) ?? 0;\n        return delta + (await promise);\n      },\n      reset({\n        address,\n        chainId\n      }) {\n        const key = getKey({\n          address,\n          chainId\n        });\n        deltaMap.delete(key);\n        promiseMap.delete(key);\n      }\n    };\n  }\n  function jsonRpc() {\n    return {\n      async get(parameters) {\n        const {\n          address,\n          client\n        } = parameters;\n        return (0, getTransactionCount_js_1.getTransactionCount)(client, {\n          address,\n          blockTag: 'pending'\n        });\n      },\n      set() {}\n    };\n  }\n  exports.nonceManager = createNonceManager({\n    source: jsonRpc()\n  });\n});","lineCount":126,"map":[[2,2,1,0],[2,14,1,12],[4,2,2,0,"Object"],[4,8,2,6],[4,9,2,7,"defineProperty"],[4,23,2,21],[4,24,2,22,"exports"],[4,31,2,29],[4,33,2,31],[4,45,2,43],[4,47,2,45],[5,4,2,47,"value"],[5,9,2,52],[5,11,2,54],[6,2,2,59],[6,3,2,60],[6,4,2,61],[7,2,3,0,"exports"],[7,9,3,7],[7,10,3,8,"nonceManager"],[7,22,3,20],[7,25,3,23],[7,30,3,28],[7,31,3,29],[8,2,4,0,"exports"],[8,9,4,7],[8,10,4,8,"createNonceManager"],[8,28,4,26],[8,31,4,29,"createNonceManager"],[8,49,4,47],[9,2,5,0,"exports"],[9,9,5,7],[9,10,5,8,"jsonRpc"],[9,17,5,15],[9,20,5,18,"jsonRpc"],[9,27,5,25],[10,2,6,0],[10,8,6,6,"getTransactionCount_js_1"],[10,32,6,30],[10,35,6,33,"require"],[10,42,6,40],[10,43,6,40,"_dependencyMap"],[10,57,6,40],[10,104,6,83],[10,105,6,84],[11,2,7,0],[11,8,7,6,"lru_js_1"],[11,16,7,14],[11,19,7,17,"require"],[11,26,7,24],[11,27,7,24,"_dependencyMap"],[11,41,7,24],[11,56,7,35],[11,57,7,36],[12,2,8,0],[12,11,8,9,"createNonceManager"],[12,29,8,27,"createNonceManager"],[12,30,8,28,"parameters"],[12,40,8,38],[12,42,8,40],[13,4,9,4],[13,10,9,10],[14,6,9,12,"source"],[15,4,9,19],[15,5,9,20],[15,8,9,23,"parameters"],[15,18,9,33],[16,4,10,4],[16,10,10,10,"deltaMap"],[16,18,10,18],[16,21,10,21],[16,25,10,25,"Map"],[16,28,10,28],[16,29,10,29],[16,30,10,30],[17,4,11,4],[17,10,11,10,"nonceMap"],[17,18,11,18],[17,21,11,21],[17,25,11,25,"lru_js_1"],[17,33,11,33],[17,34,11,34,"LruMap"],[17,40,11,40],[17,41,11,41],[17,45,11,45],[17,46,11,46],[18,4,12,4],[18,10,12,10,"promiseMap"],[18,20,12,20],[18,23,12,23],[18,27,12,27,"Map"],[18,30,12,30],[18,31,12,31],[18,32,12,32],[19,4,13,4],[19,10,13,10,"getKey"],[19,16,13,16],[19,19,13,19,"getKey"],[19,20,13,20],[20,6,13,22,"address"],[20,13,13,29],[21,6,13,31,"chainId"],[22,4,13,39],[22,5,13,40],[22,10,13,45],[22,13,13,48,"address"],[22,20,13,55],[22,24,13,59,"chainId"],[22,31,13,66],[22,33,13,68],[23,4,14,4],[23,11,14,11],[24,6,15,8],[24,12,15,14,"consume"],[24,19,15,21,"consume"],[24,20,15,22],[25,8,15,24,"address"],[25,15,15,31],[26,8,15,33,"chainId"],[26,15,15,40],[27,8,15,42,"client"],[28,6,15,49],[28,7,15,50],[28,9,15,52],[29,8,16,12],[29,14,16,18,"key"],[29,17,16,21],[29,20,16,24,"getKey"],[29,26,16,30],[29,27,16,31],[30,10,16,33,"address"],[30,17,16,40],[31,10,16,42,"chainId"],[32,8,16,50],[32,9,16,51],[32,10,16,52],[33,8,17,12],[33,14,17,18,"promise"],[33,21,17,25],[33,24,17,28],[33,28,17,32],[33,29,17,33,"get"],[33,32,17,36],[33,33,17,37],[34,10,17,39,"address"],[34,17,17,46],[35,10,17,48,"chainId"],[35,17,17,55],[36,10,17,57,"client"],[37,8,17,64],[37,9,17,65],[37,10,17,66],[38,8,18,12],[38,12,18,16],[38,13,18,17,"increment"],[38,22,18,26],[38,23,18,27],[39,10,18,29,"address"],[39,17,18,36],[40,10,18,38,"chainId"],[41,8,18,46],[41,9,18,47],[41,10,18,48],[42,8,19,12],[42,14,19,18,"nonce"],[42,19,19,23],[42,22,19,26],[42,28,19,32,"promise"],[42,35,19,39],[43,8,20,12],[43,14,20,18,"source"],[43,20,20,24],[43,21,20,25,"set"],[43,24,20,28],[43,25,20,29],[44,10,20,31,"address"],[44,17,20,38],[45,10,20,40,"chainId"],[46,8,20,48],[46,9,20,49],[46,11,20,51,"nonce"],[46,16,20,56],[46,17,20,57],[47,8,21,12,"nonceMap"],[47,16,21,20],[47,17,21,21,"set"],[47,20,21,24],[47,21,21,25,"key"],[47,24,21,28],[47,26,21,30,"nonce"],[47,31,21,35],[47,32,21,36],[48,8,22,12],[48,15,22,19,"nonce"],[48,20,22,24],[49,6,23,8],[49,7,23,9],[50,6,24,8],[50,12,24,14,"increment"],[50,21,24,23,"increment"],[50,22,24,24],[51,8,24,26,"address"],[51,15,24,33],[52,8,24,35,"chainId"],[53,6,24,43],[53,7,24,44],[53,9,24,46],[54,8,25,12],[54,14,25,18,"key"],[54,17,25,21],[54,20,25,24,"getKey"],[54,26,25,30],[54,27,25,31],[55,10,25,33,"address"],[55,17,25,40],[56,10,25,42,"chainId"],[57,8,25,50],[57,9,25,51],[57,10,25,52],[58,8,26,12],[58,14,26,18,"delta"],[58,19,26,23],[58,22,26,26,"deltaMap"],[58,30,26,34],[58,31,26,35,"get"],[58,34,26,38],[58,35,26,39,"key"],[58,38,26,42],[58,39,26,43],[58,43,26,47],[58,44,26,48],[59,8,27,12,"deltaMap"],[59,16,27,20],[59,17,27,21,"set"],[59,20,27,24],[59,21,27,25,"key"],[59,24,27,28],[59,26,27,30,"delta"],[59,31,27,35],[59,34,27,38],[59,35,27,39],[59,36,27,40],[60,6,28,8],[60,7,28,9],[61,6,29,8],[61,12,29,14,"get"],[61,15,29,17,"get"],[61,16,29,18],[62,8,29,20,"address"],[62,15,29,27],[63,8,29,29,"chainId"],[63,15,29,36],[64,8,29,38,"client"],[65,6,29,45],[65,7,29,46],[65,9,29,48],[66,8,30,12],[66,14,30,18,"key"],[66,17,30,21],[66,20,30,24,"getKey"],[66,26,30,30],[66,27,30,31],[67,10,30,33,"address"],[67,17,30,40],[68,10,30,42,"chainId"],[69,8,30,50],[69,9,30,51],[69,10,30,52],[70,8,31,12],[70,12,31,16,"promise"],[70,19,31,23],[70,22,31,26,"promiseMap"],[70,32,31,36],[70,33,31,37,"get"],[70,36,31,40],[70,37,31,41,"key"],[70,40,31,44],[70,41,31,45],[71,8,32,12],[71,12,32,16],[71,13,32,17,"promise"],[71,20,32,24],[71,22,32,26],[72,10,33,16,"promise"],[72,17,33,23],[72,20,33,26],[72,21,33,27],[72,33,33,39],[73,12,34,20],[73,16,34,24],[74,14,35,24],[74,20,35,30,"nonce"],[74,25,35,35],[74,28,35,38],[74,34,35,44,"source"],[74,40,35,50],[74,41,35,51,"get"],[74,44,35,54],[74,45,35,55],[75,16,35,57,"address"],[75,23,35,64],[76,16,35,66,"chainId"],[76,23,35,73],[77,16,35,75,"client"],[78,14,35,82],[78,15,35,83],[78,16,35,84],[79,14,36,24],[79,20,36,30,"previousNonce"],[79,33,36,43],[79,36,36,46,"nonceMap"],[79,44,36,54],[79,45,36,55,"get"],[79,48,36,58],[79,49,36,59,"key"],[79,52,36,62],[79,53,36,63],[79,57,36,67],[79,58,36,68],[80,14,37,24],[80,18,37,28,"previousNonce"],[80,31,37,41],[80,34,37,44],[80,35,37,45],[80,39,37,49,"nonce"],[80,44,37,54],[80,48,37,58,"previousNonce"],[80,61,37,71],[80,63,38,28],[80,70,38,35,"previousNonce"],[80,83,38,48],[80,86,38,51],[80,87,38,52],[81,14,39,24,"nonceMap"],[81,22,39,32],[81,23,39,33,"delete"],[81,29,39,39],[81,30,39,40,"key"],[81,33,39,43],[81,34,39,44],[82,14,40,24],[82,21,40,31,"nonce"],[82,26,40,36],[83,12,41,20],[83,13,41,21],[83,22,42,28],[84,14,43,24],[84,18,43,28],[84,19,43,29,"reset"],[84,24,43,34],[84,25,43,35],[85,16,43,37,"address"],[85,23,43,44],[86,16,43,46,"chainId"],[87,14,43,54],[87,15,43,55],[87,16,43,56],[88,12,44,20],[89,10,45,16],[89,11,45,17],[89,13,45,19],[89,14,45,20],[90,10,46,16,"promiseMap"],[90,20,46,26],[90,21,46,27,"set"],[90,24,46,30],[90,25,46,31,"key"],[90,28,46,34],[90,30,46,36,"promise"],[90,37,46,43],[90,38,46,44],[91,8,47,12],[92,8,48,12],[92,14,48,18,"delta"],[92,19,48,23],[92,22,48,26,"deltaMap"],[92,30,48,34],[92,31,48,35,"get"],[92,34,48,38],[92,35,48,39,"key"],[92,38,48,42],[92,39,48,43],[92,43,48,47],[92,44,48,48],[93,8,49,12],[93,15,49,19,"delta"],[93,20,49,24],[93,24,49,28],[93,30,49,34,"promise"],[93,37,49,41],[93,38,49,42],[94,6,50,8],[94,7,50,9],[95,6,51,8,"reset"],[95,11,51,13,"reset"],[95,12,51,14],[96,8,51,16,"address"],[96,15,51,23],[97,8,51,25,"chainId"],[98,6,51,33],[98,7,51,34],[98,9,51,36],[99,8,52,12],[99,14,52,18,"key"],[99,17,52,21],[99,20,52,24,"getKey"],[99,26,52,30],[99,27,52,31],[100,10,52,33,"address"],[100,17,52,40],[101,10,52,42,"chainId"],[102,8,52,50],[102,9,52,51],[102,10,52,52],[103,8,53,12,"deltaMap"],[103,16,53,20],[103,17,53,21,"delete"],[103,23,53,27],[103,24,53,28,"key"],[103,27,53,31],[103,28,53,32],[104,8,54,12,"promiseMap"],[104,18,54,22],[104,19,54,23,"delete"],[104,25,54,29],[104,26,54,30,"key"],[104,29,54,33],[104,30,54,34],[105,6,55,8],[106,4,56,4],[106,5,56,5],[107,2,57,0],[108,2,58,0],[108,11,58,9,"jsonRpc"],[108,18,58,16,"jsonRpc"],[108,19,58,16],[108,21,58,19],[109,4,59,4],[109,11,59,11],[110,6,60,8],[110,12,60,14,"get"],[110,15,60,17,"get"],[110,16,60,18,"parameters"],[110,26,60,28],[110,28,60,30],[111,8,61,12],[111,14,61,18],[112,10,61,20,"address"],[112,17,61,27],[113,10,61,29,"client"],[114,8,61,36],[114,9,61,37],[114,12,61,40,"parameters"],[114,22,61,50],[115,8,62,12],[115,15,62,19],[115,16,62,20],[115,17,62,21],[115,19,62,23,"getTransactionCount_js_1"],[115,43,62,47],[115,44,62,48,"getTransactionCount"],[115,63,62,67],[115,65,62,69,"client"],[115,71,62,75],[115,73,62,77],[116,10,63,16,"address"],[116,17,63,23],[117,10,64,16,"blockTag"],[117,18,64,24],[117,20,64,26],[118,8,65,12],[118,9,65,13],[118,10,65,14],[119,6,66,8],[119,7,66,9],[120,6,67,8,"set"],[120,9,67,11,"set"],[120,10,67,11],[120,12,67,14],[120,13,67,16],[121,4,68,4],[121,5,68,5],[122,2,69,0],[123,2,70,0,"exports"],[123,9,70,7],[123,10,70,8,"nonceManager"],[123,22,70,20],[123,25,70,23,"createNonceManager"],[123,43,70,41],[123,44,70,42],[124,4,71,4,"source"],[124,10,71,10],[124,12,71,12,"jsonRpc"],[124,19,71,19],[124,20,71,20],[125,2,72,0],[125,3,72,1],[125,4,72,2],[126,0,72,3],[126,3]],"functionMap":{"names":["<global>","createNonceManager","getKey","consume","increment","get","<anonymous>","reset","jsonRpc","set"],"mappings":"AAA;ACO;mBCK,iDD;QEE;SFQ;QGC;SHI;QIC;2BCI;iBDY;SJK;QMC;SNI;CDE;AQC;QHE;SGM;QCC,SD;CRE"},"hasCjsExports":true},"type":"js/module"}]}