{"dependencies":[{"name":"../../utils/encoding/fromHex.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":1,"column":0,"index":0},"end":{"line":1,"column":62,"index":62}}],"key":"uknfOLKh4Zy1p0iweRTTuAj/fYc=","exportNames":["*"],"imports":1}},{"name":"../../utils/getAction.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":2,"column":0,"index":63},"end":{"line":2,"column":53,"index":116}}],"key":"vt4scbNyA2t/tyY0oQJI6AZPJS4=","exportNames":["*"],"imports":1}},{"name":"../../utils/observe.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":3,"column":0,"index":117},"end":{"line":3,"column":49,"index":166}}],"key":"HKjcCKJVuiHtohOTQ78FBQFk94I=","exportNames":["*"],"imports":1}},{"name":"../../utils/poll.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":4,"column":0,"index":167},"end":{"line":4,"column":43,"index":210}}],"key":"Vy9/0HY5f9EZBKje2fl3cZrd9b0=","exportNames":["*"],"imports":1}},{"name":"../../utils/stringify.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":5,"column":0,"index":211},"end":{"line":5,"column":53,"index":264}}],"key":"hATh5RA/q0TQG1HzvPAqv2f5XM8=","exportNames":["*"],"imports":1}},{"name":"./getBlockNumber.js","data":{"asyncType":null,"isESMImport":true,"locs":[{"start":{"line":6,"column":0,"index":265},"end":{"line":6,"column":54,"index":319}}],"key":"vkmLol6zSAC8PjrcpHPHKsNs0ws=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, '__esModule', {\n    value: true\n  });\n  exports.watchBlockNumber = watchBlockNumber;\n  var _utilsEncodingFromHexJs = require(_dependencyMap[0], \"../../utils/encoding/fromHex.js\");\n  var _utilsGetActionJs = require(_dependencyMap[1], \"../../utils/getAction.js\");\n  var _utilsObserveJs = require(_dependencyMap[2], \"../../utils/observe.js\");\n  var _utilsPollJs = require(_dependencyMap[3], \"../../utils/poll.js\");\n  var _utilsStringifyJs = require(_dependencyMap[4], \"../../utils/stringify.js\");\n  var _getBlockNumberJs = require(_dependencyMap[5], \"./getBlockNumber.js\");\n  /**\n   * Watches and returns incoming block numbers.\n   *\n   * - Docs: https://viem.sh/docs/actions/public/watchBlockNumber\n   * - Examples: https://stackblitz.com/github/wevm/viem/tree/main/examples/blocks_watching-blocks\n   * - JSON-RPC Methods:\n   *   - When `poll: true`, calls [`eth_blockNumber`](https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_blocknumber) on a polling interval.\n   *   - When `poll: false` & WebSocket Transport, uses a WebSocket subscription via [`eth_subscribe`](https://docs.alchemy.com/reference/eth-subscribe-polygon) and the `\"newHeads\"` event.\n   *\n   * @param client - Client to use\n   * @param parameters - {@link WatchBlockNumberParameters}\n   * @returns A function that can be invoked to stop watching for new block numbers. {@link WatchBlockNumberReturnType}\n   *\n   * @example\n   * import { createPublicClient, watchBlockNumber, http } from 'viem'\n   * import { mainnet } from 'viem/chains'\n   *\n   * const client = createPublicClient({\n   *   chain: mainnet,\n   *   transport: http(),\n   * })\n   * const unwatch = watchBlockNumber(client, {\n   *   onBlockNumber: (blockNumber) => console.log(blockNumber),\n   * })\n   */\n  function watchBlockNumber(client, {\n    emitOnBegin = false,\n    emitMissed = false,\n    onBlockNumber,\n    onError,\n    poll: poll_,\n    pollingInterval = client.pollingInterval\n  }) {\n    const enablePolling = (() => {\n      if (typeof poll_ !== 'undefined') return poll_;\n      if (client.transport.type === 'webSocket') return false;\n      if (client.transport.type === 'fallback' && client.transport.transports[0].config.type === 'webSocket') return false;\n      return true;\n    })();\n    let prevBlockNumber;\n    const pollBlockNumber = () => {\n      const observerId = (0, _utilsStringifyJs.stringify)(['watchBlockNumber', client.uid, emitOnBegin, emitMissed, pollingInterval]);\n      return (0, _utilsObserveJs.observe)(observerId, {\n        onBlockNumber,\n        onError\n      }, emit => (0, _utilsPollJs.poll)(async () => {\n        try {\n          const blockNumber = await (0, _utilsGetActionJs.getAction)(client, _getBlockNumberJs.getBlockNumber, 'getBlockNumber')({\n            cacheTime: 0\n          });\n          if (prevBlockNumber) {\n            // If the current block number is the same as the previous,\n            // we can skip.\n            if (blockNumber === prevBlockNumber) return;\n            // If we have missed out on some previous blocks, and the\n            // `emitMissed` flag is truthy, let's emit those blocks.\n            if (blockNumber - prevBlockNumber > 1 && emitMissed) {\n              for (let i = prevBlockNumber + 1n; i < blockNumber; i++) {\n                emit.onBlockNumber(i, prevBlockNumber);\n                prevBlockNumber = i;\n              }\n            }\n          }\n          // If the next block number is greater than the previous,\n          // it is not in the past, and we can emit the new block number.\n          if (!prevBlockNumber || blockNumber > prevBlockNumber) {\n            emit.onBlockNumber(blockNumber, prevBlockNumber);\n            prevBlockNumber = blockNumber;\n          }\n        } catch (err) {\n          emit.onError?.(err);\n        }\n      }, {\n        emitOnBegin,\n        interval: pollingInterval\n      }));\n    };\n    const subscribeBlockNumber = () => {\n      const observerId = (0, _utilsStringifyJs.stringify)(['watchBlockNumber', client.uid, emitOnBegin, emitMissed]);\n      return (0, _utilsObserveJs.observe)(observerId, {\n        onBlockNumber,\n        onError\n      }, emit => {\n        let active = true;\n        let unsubscribe = () => active = false;\n        (async () => {\n          try {\n            const transport = (() => {\n              if (client.transport.type === 'fallback') {\n                const transport = client.transport.transports.find(transport => transport.config.type === 'webSocket');\n                if (!transport) return client.transport;\n                return transport.value;\n              }\n              return client.transport;\n            })();\n            const {\n              unsubscribe: unsubscribe_\n            } = await transport.subscribe({\n              params: ['newHeads'],\n              onData(data) {\n                if (!active) return;\n                const blockNumber = (0, _utilsEncodingFromHexJs.hexToBigInt)(data.result?.number);\n                emit.onBlockNumber(blockNumber, prevBlockNumber);\n                prevBlockNumber = blockNumber;\n              },\n              onError(error) {\n                emit.onError?.(error);\n              }\n            });\n            unsubscribe = unsubscribe_;\n            if (!active) unsubscribe();\n          } catch (err) {\n            onError?.(err);\n          }\n        })();\n        return () => unsubscribe();\n      });\n    };\n    return enablePolling ? pollBlockNumber() : subscribeBlockNumber();\n  }\n});","lineCount":134,"map":[[7,2,32,0,"exports"],[7,9,32,0],[7,10,32,0,"watchBlockNumber"],[7,26,32,0],[7,29,32,0,"watchBlockNumber"],[7,45,32,0],[8,2,1,0],[8,6,1,0,"_utilsEncodingFromHexJs"],[8,29,1,0],[8,32,1,0,"require"],[8,39,1,0],[8,40,1,0,"_dependencyMap"],[8,54,1,0],[9,2,2,0],[9,6,2,0,"_utilsGetActionJs"],[9,23,2,0],[9,26,2,0,"require"],[9,33,2,0],[9,34,2,0,"_dependencyMap"],[9,48,2,0],[10,2,3,0],[10,6,3,0,"_utilsObserveJs"],[10,21,3,0],[10,24,3,0,"require"],[10,31,3,0],[10,32,3,0,"_dependencyMap"],[10,46,3,0],[11,2,4,0],[11,6,4,0,"_utilsPollJs"],[11,18,4,0],[11,21,4,0,"require"],[11,28,4,0],[11,29,4,0,"_dependencyMap"],[11,43,4,0],[12,2,5,0],[12,6,5,0,"_utilsStringifyJs"],[12,23,5,0],[12,26,5,0,"require"],[12,33,5,0],[12,34,5,0,"_dependencyMap"],[12,48,5,0],[13,2,6,0],[13,6,6,0,"_getBlockNumberJs"],[13,23,6,0],[13,26,6,0,"require"],[13,33,6,0],[13,34,6,0,"_dependencyMap"],[13,48,6,0],[14,2,7,0],[15,0,8,0],[16,0,9,0],[17,0,10,0],[18,0,11,0],[19,0,12,0],[20,0,13,0],[21,0,14,0],[22,0,15,0],[23,0,16,0],[24,0,17,0],[25,0,18,0],[26,0,19,0],[27,0,20,0],[28,0,21,0],[29,0,22,0],[30,0,23,0],[31,0,24,0],[32,0,25,0],[33,0,26,0],[34,0,27,0],[35,0,28,0],[36,0,29,0],[37,0,30,0],[38,0,31,0],[39,2,32,7],[39,11,32,16,"watchBlockNumber"],[39,27,32,32,"watchBlockNumber"],[39,28,32,33,"client"],[39,34,32,39],[39,36,32,41],[40,4,32,43,"emitOnBegin"],[40,15,32,54],[40,18,32,57],[40,23,32,62],[41,4,32,64,"emitMissed"],[41,14,32,74],[41,17,32,77],[41,22,32,82],[42,4,32,84,"onBlockNumber"],[42,17,32,97],[43,4,32,99,"onError"],[43,11,32,106],[44,4,32,108,"poll"],[44,8,32,112],[44,10,32,114,"poll_"],[44,15,32,119],[45,4,32,121,"pollingInterval"],[45,19,32,136],[45,22,32,139,"client"],[45,28,32,145],[45,29,32,146,"pollingInterval"],[46,2,32,163],[46,3,32,164],[46,5,32,166],[47,4,33,4],[47,10,33,10,"enablePolling"],[47,23,33,23],[47,26,33,26],[47,27,33,27],[47,33,33,33],[48,6,34,8],[48,10,34,12],[48,17,34,19,"poll_"],[48,22,34,24],[48,27,34,29],[48,38,34,40],[48,40,35,12],[48,47,35,19,"poll_"],[48,52,35,24],[49,6,36,8],[49,10,36,12,"client"],[49,16,36,18],[49,17,36,19,"transport"],[49,26,36,28],[49,27,36,29,"type"],[49,31,36,33],[49,36,36,38],[49,47,36,49],[49,49,37,12],[49,56,37,19],[49,61,37,24],[50,6,38,8],[50,10,38,12,"client"],[50,16,38,18],[50,17,38,19,"transport"],[50,26,38,28],[50,27,38,29,"type"],[50,31,38,33],[50,36,38,38],[50,46,38,48],[50,50,39,12,"client"],[50,56,39,18],[50,57,39,19,"transport"],[50,66,39,28],[50,67,39,29,"transports"],[50,77,39,39],[50,78,39,40],[50,79,39,41],[50,80,39,42],[50,81,39,43,"config"],[50,87,39,49],[50,88,39,50,"type"],[50,92,39,54],[50,97,39,59],[50,108,39,70],[50,110,40,12],[50,117,40,19],[50,122,40,24],[51,6,41,8],[51,13,41,15],[51,17,41,19],[52,4,42,4],[52,5,42,5],[52,7,42,7],[52,8,42,8],[53,4,43,4],[53,8,43,8,"prevBlockNumber"],[53,23,43,23],[54,4,44,4],[54,10,44,10,"pollBlockNumber"],[54,25,44,25],[54,28,44,28,"pollBlockNumber"],[54,29,44,28],[54,34,44,34],[55,6,45,8],[55,12,45,14,"observerId"],[55,22,45,24],[55,25,45,27],[55,29,45,27,"stringify"],[55,46,45,36],[55,47,45,36,"stringify"],[55,56,45,36],[55,58,45,37],[55,59,46,12],[55,77,46,30],[55,79,47,12,"client"],[55,85,47,18],[55,86,47,19,"uid"],[55,89,47,22],[55,91,48,12,"emitOnBegin"],[55,102,48,23],[55,104,49,12,"emitMissed"],[55,114,49,22],[55,116,50,12,"pollingInterval"],[55,131,50,27],[55,132,51,9],[55,133,51,10],[56,6,52,8],[56,13,52,15],[56,17,52,15,"observe"],[56,32,52,22],[56,33,52,22,"observe"],[56,40,52,22],[56,42,52,23,"observerId"],[56,52,52,33],[56,54,52,35],[57,8,52,37,"onBlockNumber"],[57,21,52,50],[58,8,52,52,"onError"],[59,6,52,60],[59,7,52,61],[59,9,52,64,"emit"],[59,13,52,68],[59,17,52,73],[59,21,52,73,"poll"],[59,33,52,77],[59,34,52,77,"poll"],[59,38,52,77],[59,40,52,78],[59,52,52,90],[60,8,53,12],[60,12,53,16],[61,10,54,16],[61,16,54,22,"blockNumber"],[61,27,54,33],[61,30,54,36],[61,36,54,42],[61,40,54,42,"getAction"],[61,57,54,51],[61,58,54,51,"getAction"],[61,67,54,51],[61,69,54,52,"client"],[61,75,54,58],[61,77,54,60,"getBlockNumber"],[61,94,54,74],[61,95,54,74,"getBlockNumber"],[61,109,54,74],[61,111,54,76],[61,127,54,92],[61,128,54,93],[61,129,54,94],[62,12,54,96,"cacheTime"],[62,21,54,105],[62,23,54,107],[63,10,54,109],[63,11,54,110],[63,12,54,111],[64,10,55,16],[64,14,55,20,"prevBlockNumber"],[64,29,55,35],[64,31,55,37],[65,12,56,20],[66,12,57,20],[67,12,58,20],[67,16,58,24,"blockNumber"],[67,27,58,35],[67,32,58,40,"prevBlockNumber"],[67,47,58,55],[67,49,59,24],[68,12,60,20],[69,12,61,20],[70,12,62,20],[70,16,62,24,"blockNumber"],[70,27,62,35],[70,30,62,38,"prevBlockNumber"],[70,45,62,53],[70,48,62,56],[70,49,62,57],[70,53,62,61,"emitMissed"],[70,63,62,71],[70,65,62,73],[71,14,63,24],[71,19,63,29],[71,23,63,33,"i"],[71,24,63,34],[71,27,63,37,"prevBlockNumber"],[71,42,63,52],[71,45,63,55],[71,47,63,57],[71,49,63,59,"i"],[71,50,63,60],[71,53,63,63,"blockNumber"],[71,64,63,74],[71,66,63,76,"i"],[71,67,63,77],[71,69,63,79],[71,71,63,81],[72,16,64,28,"emit"],[72,20,64,32],[72,21,64,33,"onBlockNumber"],[72,34,64,46],[72,35,64,47,"i"],[72,36,64,48],[72,38,64,50,"prevBlockNumber"],[72,53,64,65],[72,54,64,66],[73,16,65,28,"prevBlockNumber"],[73,31,65,43],[73,34,65,46,"i"],[73,35,65,47],[74,14,66,24],[75,12,67,20],[76,10,68,16],[77,10,69,16],[78,10,70,16],[79,10,71,16],[79,14,71,20],[79,15,71,21,"prevBlockNumber"],[79,30,71,36],[79,34,71,40,"blockNumber"],[79,45,71,51],[79,48,71,54,"prevBlockNumber"],[79,63,71,69],[79,65,71,71],[80,12,72,20,"emit"],[80,16,72,24],[80,17,72,25,"onBlockNumber"],[80,30,72,38],[80,31,72,39,"blockNumber"],[80,42,72,50],[80,44,72,52,"prevBlockNumber"],[80,59,72,67],[80,60,72,68],[81,12,73,20,"prevBlockNumber"],[81,27,73,35],[81,30,73,38,"blockNumber"],[81,41,73,49],[82,10,74,16],[83,8,75,12],[83,9,75,13],[83,10,76,12],[83,17,76,19,"err"],[83,20,76,22],[83,22,76,24],[84,10,77,16,"emit"],[84,14,77,20],[84,15,77,21,"onError"],[84,22,77,28],[84,25,77,31,"err"],[84,28,77,34],[84,29,77,35],[85,8,78,12],[86,6,79,8],[86,7,79,9],[86,9,79,11],[87,8,80,12,"emitOnBegin"],[87,19,80,23],[88,8,81,12,"interval"],[88,16,81,20],[88,18,81,22,"pollingInterval"],[89,6,82,8],[89,7,82,9],[89,8,82,10],[89,9,82,11],[90,4,83,4],[90,5,83,5],[91,4,84,4],[91,10,84,10,"subscribeBlockNumber"],[91,30,84,30],[91,33,84,33,"subscribeBlockNumber"],[91,34,84,33],[91,39,84,39],[92,6,85,8],[92,12,85,14,"observerId"],[92,22,85,24],[92,25,85,27],[92,29,85,27,"stringify"],[92,46,85,36],[92,47,85,36,"stringify"],[92,56,85,36],[92,58,85,37],[92,59,86,12],[92,77,86,30],[92,79,87,12,"client"],[92,85,87,18],[92,86,87,19,"uid"],[92,89,87,22],[92,91,88,12,"emitOnBegin"],[92,102,88,23],[92,104,89,12,"emitMissed"],[92,114,89,22],[92,115,90,9],[92,116,90,10],[93,6,91,8],[93,13,91,15],[93,17,91,15,"observe"],[93,32,91,22],[93,33,91,22,"observe"],[93,40,91,22],[93,42,91,23,"observerId"],[93,52,91,33],[93,54,91,35],[94,8,91,37,"onBlockNumber"],[94,21,91,50],[95,8,91,52,"onError"],[96,6,91,60],[96,7,91,61],[96,9,91,64,"emit"],[96,13,91,68],[96,17,91,73],[97,8,92,12],[97,12,92,16,"active"],[97,18,92,22],[97,21,92,25],[97,25,92,29],[98,8,93,12],[98,12,93,16,"unsubscribe"],[98,23,93,27],[98,26,93,30,"unsubscribe"],[98,27,93,30],[98,32,93,37,"active"],[98,38,93,43],[98,41,93,46],[98,46,93,52],[99,8,94,12],[99,9,94,13],[99,21,94,25],[100,10,95,16],[100,14,95,20],[101,12,96,20],[101,18,96,26,"transport"],[101,27,96,35],[101,30,96,38],[101,31,96,39],[101,37,96,45],[102,14,97,24],[102,18,97,28,"client"],[102,24,97,34],[102,25,97,35,"transport"],[102,34,97,44],[102,35,97,45,"type"],[102,39,97,49],[102,44,97,54],[102,54,97,64],[102,56,97,66],[103,16,98,28],[103,22,98,34,"transport"],[103,31,98,43],[103,34,98,46,"client"],[103,40,98,52],[103,41,98,53,"transport"],[103,50,98,62],[103,51,98,63,"transports"],[103,61,98,73],[103,62,98,74,"find"],[103,66,98,78],[103,67,98,80,"transport"],[103,76,98,89],[103,80,98,94,"transport"],[103,89,98,103],[103,90,98,104,"config"],[103,96,98,110],[103,97,98,111,"type"],[103,101,98,115],[103,106,98,120],[103,117,98,131],[103,118,98,132],[104,16,99,28],[104,20,99,32],[104,21,99,33,"transport"],[104,30,99,42],[104,32,100,32],[104,39,100,39,"client"],[104,45,100,45],[104,46,100,46,"transport"],[104,55,100,55],[105,16,101,28],[105,23,101,35,"transport"],[105,32,101,44],[105,33,101,45,"value"],[105,38,101,50],[106,14,102,24],[107,14,103,24],[107,21,103,31,"client"],[107,27,103,37],[107,28,103,38,"transport"],[107,37,103,47],[108,12,104,20],[108,13,104,21],[108,15,104,23],[108,16,104,24],[109,12,105,20],[109,18,105,26],[110,14,105,28,"unsubscribe"],[110,25,105,39],[110,27,105,41,"unsubscribe_"],[111,12,105,54],[111,13,105,55],[111,16,105,58],[111,22,105,64,"transport"],[111,31,105,73],[111,32,105,74,"subscribe"],[111,41,105,83],[111,42,105,84],[112,14,106,24,"params"],[112,20,106,30],[112,22,106,32],[112,23,106,33],[112,33,106,43],[112,34,106,44],[113,14,107,24,"onData"],[113,20,107,30,"onData"],[113,21,107,31,"data"],[113,25,107,35],[113,27,107,37],[114,16,108,28],[114,20,108,32],[114,21,108,33,"active"],[114,27,108,39],[114,29,109,32],[115,16,110,28],[115,22,110,34,"blockNumber"],[115,33,110,45],[115,36,110,48],[115,40,110,48,"hexToBigInt"],[115,63,110,59],[115,64,110,59,"hexToBigInt"],[115,75,110,59],[115,77,110,60,"data"],[115,81,110,64],[115,82,110,65,"result"],[115,88,110,71],[115,90,110,73,"number"],[115,96,110,79],[115,97,110,80],[116,16,111,28,"emit"],[116,20,111,32],[116,21,111,33,"onBlockNumber"],[116,34,111,46],[116,35,111,47,"blockNumber"],[116,46,111,58],[116,48,111,60,"prevBlockNumber"],[116,63,111,75],[116,64,111,76],[117,16,112,28,"prevBlockNumber"],[117,31,112,43],[117,34,112,46,"blockNumber"],[117,45,112,57],[118,14,113,24],[118,15,113,25],[119,14,114,24,"onError"],[119,21,114,31,"onError"],[119,22,114,32,"error"],[119,27,114,37],[119,29,114,39],[120,16,115,28,"emit"],[120,20,115,32],[120,21,115,33,"onError"],[120,28,115,40],[120,31,115,43,"error"],[120,36,115,48],[120,37,115,49],[121,14,116,24],[122,12,117,20],[122,13,117,21],[122,14,117,22],[123,12,118,20,"unsubscribe"],[123,23,118,31],[123,26,118,34,"unsubscribe_"],[123,38,118,46],[124,12,119,20],[124,16,119,24],[124,17,119,25,"active"],[124,23,119,31],[124,25,120,24,"unsubscribe"],[124,36,120,35],[124,37,120,36],[124,38,120,37],[125,10,121,16],[125,11,121,17],[125,12,122,16],[125,19,122,23,"err"],[125,22,122,26],[125,24,122,28],[126,12,123,20,"onError"],[126,19,123,27],[126,22,123,30,"err"],[126,25,123,33],[126,26,123,34],[127,10,124,16],[128,8,125,12],[128,9,125,13],[128,11,125,15],[128,12,125,16],[129,8,126,12],[129,15,126,19],[129,21,126,25,"unsubscribe"],[129,32,126,36],[129,33,126,37],[129,34,126,38],[130,6,127,8],[130,7,127,9],[130,8,127,10],[131,4,128,4],[131,5,128,5],[132,4,129,4],[132,11,129,11,"enablePolling"],[132,24,129,24],[132,27,129,27,"pollBlockNumber"],[132,42,129,42],[132,43,129,43],[132,44,129,44],[132,47,129,47,"subscribeBlockNumber"],[132,67,129,67],[132,68,129,68],[132,69,129,69],[133,2,130,0],[134,0,130,1],[134,3]],"functionMap":{"names":["<global>","watchBlockNumber","<anonymous>","pollBlockNumber","observe$argument_2","poll$argument_0","subscribeBlockNumber","unsubscribe","client.transport.transports.find$argument_0","transport.subscribe$argument_0.onData","transport.subscribe$argument_0.onError"],"mappings":"AAA;OC+B;2BCC;KDS;4BEE;+DCQ,eC;SD2B;UDG;KFC;iCKC;+DFO;8BGE,sBH;aFC;+EMI,oDN;wBOS;yBPM;wBQC;yBRE;aES;mBFC,mBE;SEC;KLC;CDE"},"hasCjsExports":false},"type":"js/module"}]}