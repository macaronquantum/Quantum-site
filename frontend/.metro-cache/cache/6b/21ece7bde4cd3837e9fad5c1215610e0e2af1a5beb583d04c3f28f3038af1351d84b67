{"dependencies":[{"name":"@ledgerhq/errors","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":3,"column":17,"index":94},"end":{"line":3,"column":44,"index":121}}],"key":"arrYL/Db6POWKOBPyXvHvPnB40M=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  const errors_1 = require(_dependencyMap[0], \"@ledgerhq/errors\");\n  const Tag = 0x05;\n  function asUInt16BE(value) {\n    const b = Buffer.alloc(2);\n    b.writeUInt16BE(value, 0);\n    return b;\n  }\n  const initialAcc = {\n    data: Buffer.alloc(0),\n    dataLength: 0,\n    sequence: 0\n  };\n  /**\n   * Object to handle HID frames (encoding and decoding)\n   *\n   * @param channel\n   * @param packetSize The HID protocol packet size in bytes (usually 64)\n   */\n  const createHIDframing = (channel, packetSize) => {\n    return {\n      /**\n       * Frames/encodes an APDU message into HID USB packets/frames\n       *\n       * @param apdu The APDU message to send, in a Buffer containing [cla, ins, p1, p2, data length, data(if not empty)]\n       * @returns an array of HID USB frames ready to be sent\n       */\n      makeBlocks(apdu) {\n        // Encodes the APDU length in 2 bytes before the APDU itself.\n        // The length is measured as the number of bytes.\n        // As the size of the APDU `data` should have been added in 1 byte just before `data`,\n        // the minimum size of an APDU is 5 bytes.\n        let data = Buffer.concat([asUInt16BE(apdu.length), apdu]);\n        const blockSize = packetSize - 5;\n        const nbBlocks = Math.ceil(data.length / blockSize);\n        // Fills data with 0-padding\n        data = Buffer.concat([data, Buffer.alloc(nbBlocks * blockSize - data.length + 1).fill(0)]);\n        const blocks = [];\n        for (let i = 0; i < nbBlocks; i++) {\n          const head = Buffer.alloc(5);\n          head.writeUInt16BE(channel, 0);\n          head.writeUInt8(Tag, 2);\n          head.writeUInt16BE(i, 3);\n          // `slice` and not `subarray`: this might not be a Node Buffer, but probably only a Uint8Array\n          const chunk = data.slice(i * blockSize, (i + 1) * blockSize);\n          blocks.push(Buffer.concat([head, chunk]));\n        }\n        return blocks;\n      },\n      /**\n       * Reduces HID USB packets/frames to one response.\n       *\n       * @param acc The value resulting from (accumulating) the previous call of reduceResponse.\n       *   On first call initialized to `initialAcc`. The accumulator enables handling multi-frames messages.\n       * @param chunk Current chunk to reduce into accumulator\n       * @returns An accumulator value updated with the current chunk\n       */\n      reduceResponse(acc, chunk) {\n        let {\n          data,\n          dataLength,\n          sequence\n        } = acc || initialAcc;\n        if (chunk.readUInt16BE(0) !== channel) {\n          throw new errors_1.TransportError(\"Invalid channel\", \"InvalidChannel\");\n        }\n        if (chunk.readUInt8(2) !== Tag) {\n          throw new errors_1.TransportError(\"Invalid tag\", \"InvalidTag\");\n        }\n        if (chunk.readUInt16BE(3) !== sequence) {\n          throw new errors_1.TransportError(\"Invalid sequence\", \"InvalidSequence\");\n        }\n        // Gets the total length of the response from the 1st frame\n        if (!acc) {\n          dataLength = chunk.readUInt16BE(5);\n        }\n        sequence++;\n        // The total length on the 1st frame takes 2 more bytes\n        const chunkData = chunk.slice(acc ? 5 : 7);\n        data = Buffer.concat([data, chunkData]);\n        // Removes any 0 padding\n        if (data.length > dataLength) {\n          data = data.slice(0, dataLength);\n        }\n        return {\n          data,\n          dataLength,\n          sequence\n        };\n      },\n      /**\n       * Returns the response message that has been reduced from the HID USB frames\n       *\n       * @param acc The accumulator\n       * @returns A Buffer containing the cleaned response message, or null if no response message, or undefined if the\n       *   accumulator is incorrect (message length is not valid)\n       */\n      getReducedResult(acc) {\n        if (acc && acc.dataLength === acc.data.length) {\n          return acc.data;\n        }\n      }\n    };\n  };\n  exports.default = createHIDframing;\n});","lineCount":111,"map":[[2,2,1,0],[2,14,1,12],[4,2,2,0,"Object"],[4,8,2,6],[4,9,2,7,"defineProperty"],[4,23,2,21],[4,24,2,22,"exports"],[4,31,2,29],[4,33,2,31],[4,45,2,43],[4,47,2,45],[5,4,2,47,"value"],[5,9,2,52],[5,11,2,54],[6,2,2,59],[6,3,2,60],[6,4,2,61],[7,2,3,0],[7,8,3,6,"errors_1"],[7,16,3,14],[7,19,3,17,"require"],[7,26,3,24],[7,27,3,24,"_dependencyMap"],[7,41,3,24],[7,64,3,43],[7,65,3,44],[8,2,4,0],[8,8,4,6,"Tag"],[8,11,4,9],[8,14,4,12],[8,18,4,16],[9,2,5,0],[9,11,5,9,"asUInt16BE"],[9,21,5,19,"asUInt16BE"],[9,22,5,20,"value"],[9,27,5,25],[9,29,5,27],[10,4,6,4],[10,10,6,10,"b"],[10,11,6,11],[10,14,6,14,"Buffer"],[10,20,6,20],[10,21,6,21,"alloc"],[10,26,6,26],[10,27,6,27],[10,28,6,28],[10,29,6,29],[11,4,7,4,"b"],[11,5,7,5],[11,6,7,6,"writeUInt16BE"],[11,19,7,19],[11,20,7,20,"value"],[11,25,7,25],[11,27,7,27],[11,28,7,28],[11,29,7,29],[12,4,8,4],[12,11,8,11,"b"],[12,12,8,12],[13,2,9,0],[14,2,10,0],[14,8,10,6,"initialAcc"],[14,18,10,16],[14,21,10,19],[15,4,11,4,"data"],[15,8,11,8],[15,10,11,10,"Buffer"],[15,16,11,16],[15,17,11,17,"alloc"],[15,22,11,22],[15,23,11,23],[15,24,11,24],[15,25,11,25],[16,4,12,4,"dataLength"],[16,14,12,14],[16,16,12,16],[16,17,12,17],[17,4,13,4,"sequence"],[17,12,13,12],[17,14,13,14],[18,2,14,0],[18,3,14,1],[19,2,15,0],[20,0,16,0],[21,0,17,0],[22,0,18,0],[23,0,19,0],[24,0,20,0],[25,2,21,0],[25,8,21,6,"createHIDframing"],[25,24,21,22],[25,27,21,25,"createHIDframing"],[25,28,21,26,"channel"],[25,35,21,33],[25,37,21,35,"packetSize"],[25,47,21,45],[25,52,21,50],[26,4,22,4],[26,11,22,11],[27,6,23,8],[28,0,24,0],[29,0,25,0],[30,0,26,0],[31,0,27,0],[32,0,28,0],[33,6,29,8,"makeBlocks"],[33,16,29,18,"makeBlocks"],[33,17,29,19,"apdu"],[33,21,29,23],[33,23,29,25],[34,8,30,12],[35,8,31,12],[36,8,32,12],[37,8,33,12],[38,8,34,12],[38,12,34,16,"data"],[38,16,34,20],[38,19,34,23,"Buffer"],[38,25,34,29],[38,26,34,30,"concat"],[38,32,34,36],[38,33,34,37],[38,34,34,38,"asUInt16BE"],[38,44,34,48],[38,45,34,49,"apdu"],[38,49,34,53],[38,50,34,54,"length"],[38,56,34,60],[38,57,34,61],[38,59,34,63,"apdu"],[38,63,34,67],[38,64,34,68],[38,65,34,69],[39,8,35,12],[39,14,35,18,"blockSize"],[39,23,35,27],[39,26,35,30,"packetSize"],[39,36,35,40],[39,39,35,43],[39,40,35,44],[40,8,36,12],[40,14,36,18,"nbBlocks"],[40,22,36,26],[40,25,36,29,"Math"],[40,29,36,33],[40,30,36,34,"ceil"],[40,34,36,38],[40,35,36,39,"data"],[40,39,36,43],[40,40,36,44,"length"],[40,46,36,50],[40,49,36,53,"blockSize"],[40,58,36,62],[40,59,36,63],[41,8,37,12],[42,8,38,12,"data"],[42,12,38,16],[42,15,38,19,"Buffer"],[42,21,38,25],[42,22,38,26,"concat"],[42,28,38,32],[42,29,38,33],[42,30,38,34,"data"],[42,34,38,38],[42,36,38,40,"Buffer"],[42,42,38,46],[42,43,38,47,"alloc"],[42,48,38,52],[42,49,38,53,"nbBlocks"],[42,57,38,61],[42,60,38,64,"blockSize"],[42,69,38,73],[42,72,38,76,"data"],[42,76,38,80],[42,77,38,81,"length"],[42,83,38,87],[42,86,38,90],[42,87,38,91],[42,88,38,92],[42,89,38,93,"fill"],[42,93,38,97],[42,94,38,98],[42,95,38,99],[42,96,38,100],[42,97,38,101],[42,98,38,102],[43,8,39,12],[43,14,39,18,"blocks"],[43,20,39,24],[43,23,39,27],[43,25,39,29],[44,8,40,12],[44,13,40,17],[44,17,40,21,"i"],[44,18,40,22],[44,21,40,25],[44,22,40,26],[44,24,40,28,"i"],[44,25,40,29],[44,28,40,32,"nbBlocks"],[44,36,40,40],[44,38,40,42,"i"],[44,39,40,43],[44,41,40,45],[44,43,40,47],[45,10,41,16],[45,16,41,22,"head"],[45,20,41,26],[45,23,41,29,"Buffer"],[45,29,41,35],[45,30,41,36,"alloc"],[45,35,41,41],[45,36,41,42],[45,37,41,43],[45,38,41,44],[46,10,42,16,"head"],[46,14,42,20],[46,15,42,21,"writeUInt16BE"],[46,28,42,34],[46,29,42,35,"channel"],[46,36,42,42],[46,38,42,44],[46,39,42,45],[46,40,42,46],[47,10,43,16,"head"],[47,14,43,20],[47,15,43,21,"writeUInt8"],[47,25,43,31],[47,26,43,32,"Tag"],[47,29,43,35],[47,31,43,37],[47,32,43,38],[47,33,43,39],[48,10,44,16,"head"],[48,14,44,20],[48,15,44,21,"writeUInt16BE"],[48,28,44,34],[48,29,44,35,"i"],[48,30,44,36],[48,32,44,38],[48,33,44,39],[48,34,44,40],[49,10,45,16],[50,10,46,16],[50,16,46,22,"chunk"],[50,21,46,27],[50,24,46,30,"data"],[50,28,46,34],[50,29,46,35,"slice"],[50,34,46,40],[50,35,46,41,"i"],[50,36,46,42],[50,39,46,45,"blockSize"],[50,48,46,54],[50,50,46,56],[50,51,46,57,"i"],[50,52,46,58],[50,55,46,61],[50,56,46,62],[50,60,46,66,"blockSize"],[50,69,46,75],[50,70,46,76],[51,10,47,16,"blocks"],[51,16,47,22],[51,17,47,23,"push"],[51,21,47,27],[51,22,47,28,"Buffer"],[51,28,47,34],[51,29,47,35,"concat"],[51,35,47,41],[51,36,47,42],[51,37,47,43,"head"],[51,41,47,47],[51,43,47,49,"chunk"],[51,48,47,54],[51,49,47,55],[51,50,47,56],[51,51,47,57],[52,8,48,12],[53,8,49,12],[53,15,49,19,"blocks"],[53,21,49,25],[54,6,50,8],[54,7,50,9],[55,6,51,8],[56,0,52,0],[57,0,53,0],[58,0,54,0],[59,0,55,0],[60,0,56,0],[61,0,57,0],[62,0,58,0],[63,6,59,8,"reduceResponse"],[63,20,59,22,"reduceResponse"],[63,21,59,23,"acc"],[63,24,59,26],[63,26,59,28,"chunk"],[63,31,59,33],[63,33,59,35],[64,8,60,12],[64,12,60,16],[65,10,60,18,"data"],[65,14,60,22],[66,10,60,24,"dataLength"],[66,20,60,34],[67,10,60,36,"sequence"],[68,8,60,45],[68,9,60,46],[68,12,60,49,"acc"],[68,15,60,52],[68,19,60,56,"initialAcc"],[68,29,60,66],[69,8,61,12],[69,12,61,16,"chunk"],[69,17,61,21],[69,18,61,22,"readUInt16BE"],[69,30,61,34],[69,31,61,35],[69,32,61,36],[69,33,61,37],[69,38,61,42,"channel"],[69,45,61,49],[69,47,61,51],[70,10,62,16],[70,16,62,22],[70,20,62,26,"errors_1"],[70,28,62,34],[70,29,62,35,"TransportError"],[70,43,62,49],[70,44,62,50],[70,61,62,67],[70,63,62,69],[70,79,62,85],[70,80,62,86],[71,8,63,12],[72,8,64,12],[72,12,64,16,"chunk"],[72,17,64,21],[72,18,64,22,"readUInt8"],[72,27,64,31],[72,28,64,32],[72,29,64,33],[72,30,64,34],[72,35,64,39,"Tag"],[72,38,64,42],[72,40,64,44],[73,10,65,16],[73,16,65,22],[73,20,65,26,"errors_1"],[73,28,65,34],[73,29,65,35,"TransportError"],[73,43,65,49],[73,44,65,50],[73,57,65,63],[73,59,65,65],[73,71,65,77],[73,72,65,78],[74,8,66,12],[75,8,67,12],[75,12,67,16,"chunk"],[75,17,67,21],[75,18,67,22,"readUInt16BE"],[75,30,67,34],[75,31,67,35],[75,32,67,36],[75,33,67,37],[75,38,67,42,"sequence"],[75,46,67,50],[75,48,67,52],[76,10,68,16],[76,16,68,22],[76,20,68,26,"errors_1"],[76,28,68,34],[76,29,68,35,"TransportError"],[76,43,68,49],[76,44,68,50],[76,62,68,68],[76,64,68,70],[76,81,68,87],[76,82,68,88],[77,8,69,12],[78,8,70,12],[79,8,71,12],[79,12,71,16],[79,13,71,17,"acc"],[79,16,71,20],[79,18,71,22],[80,10,72,16,"dataLength"],[80,20,72,26],[80,23,72,29,"chunk"],[80,28,72,34],[80,29,72,35,"readUInt16BE"],[80,41,72,47],[80,42,72,48],[80,43,72,49],[80,44,72,50],[81,8,73,12],[82,8,74,12,"sequence"],[82,16,74,20],[82,18,74,22],[83,8,75,12],[84,8,76,12],[84,14,76,18,"chunkData"],[84,23,76,27],[84,26,76,30,"chunk"],[84,31,76,35],[84,32,76,36,"slice"],[84,37,76,41],[84,38,76,42,"acc"],[84,41,76,45],[84,44,76,48],[84,45,76,49],[84,48,76,52],[84,49,76,53],[84,50,76,54],[85,8,77,12,"data"],[85,12,77,16],[85,15,77,19,"Buffer"],[85,21,77,25],[85,22,77,26,"concat"],[85,28,77,32],[85,29,77,33],[85,30,77,34,"data"],[85,34,77,38],[85,36,77,40,"chunkData"],[85,45,77,49],[85,46,77,50],[85,47,77,51],[86,8,78,12],[87,8,79,12],[87,12,79,16,"data"],[87,16,79,20],[87,17,79,21,"length"],[87,23,79,27],[87,26,79,30,"dataLength"],[87,36,79,40],[87,38,79,42],[88,10,80,16,"data"],[88,14,80,20],[88,17,80,23,"data"],[88,21,80,27],[88,22,80,28,"slice"],[88,27,80,33],[88,28,80,34],[88,29,80,35],[88,31,80,37,"dataLength"],[88,41,80,47],[88,42,80,48],[89,8,81,12],[90,8,82,12],[90,15,82,19],[91,10,83,16,"data"],[91,14,83,20],[92,10,84,16,"dataLength"],[92,20,84,26],[93,10,85,16,"sequence"],[94,8,86,12],[94,9,86,13],[95,6,87,8],[95,7,87,9],[96,6,88,8],[97,0,89,0],[98,0,90,0],[99,0,91,0],[100,0,92,0],[101,0,93,0],[102,0,94,0],[103,6,95,8,"getReducedResult"],[103,22,95,24,"getReducedResult"],[103,23,95,25,"acc"],[103,26,95,28],[103,28,95,30],[104,8,96,12],[104,12,96,16,"acc"],[104,15,96,19],[104,19,96,23,"acc"],[104,22,96,26],[104,23,96,27,"dataLength"],[104,33,96,37],[104,38,96,42,"acc"],[104,41,96,45],[104,42,96,46,"data"],[104,46,96,50],[104,47,96,51,"length"],[104,53,96,57],[104,55,96,59],[105,10,97,16],[105,17,97,23,"acc"],[105,20,97,26],[105,21,97,27,"data"],[105,25,97,31],[106,8,98,12],[107,6,99,8],[108,4,100,4],[108,5,100,5],[109,2,101,0],[109,3,101,1],[110,2,102,0,"exports"],[110,9,102,7],[110,10,102,8,"default"],[110,17,102,15],[110,20,102,18,"createHIDframing"],[110,36,102,34],[111,0,102,35],[111,3]],"functionMap":{"names":["<global>","asUInt16BE","createHIDframing","makeBlocks","reduceResponse","getReducedResult"],"mappings":"AAA;ACI;CDI;yBEY;QCQ;SDqB;QES;SF4B;QGQ;SHI;CFE"},"hasCjsExports":true},"type":"js/module"}]}