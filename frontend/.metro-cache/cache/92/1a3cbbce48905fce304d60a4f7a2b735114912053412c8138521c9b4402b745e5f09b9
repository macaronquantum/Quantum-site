{"dependencies":[{"name":"@trezor/utils","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":7,"column":16,"index":135},"end":{"line":7,"column":40,"index":159}}],"key":"G7HknzTAEB2ojZW8P0CsMCjZ1DA=","exportNames":["*"],"imports":1}},{"name":"../constants","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":8,"column":20,"index":181},"end":{"line":8,"column":43,"index":204}}],"key":"zmjjtqoQxi2W71eIMIIaEi1mOpU=","exportNames":["*"],"imports":1}},{"name":"../events","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":9,"column":17,"index":223},"end":{"line":9,"column":37,"index":243}}],"key":"T+/suVxFM0L6elUlJ/oc+mxw34Y=","exportNames":["*"],"imports":1}},{"name":"../utils/proxy-event-emitter","data":{"asyncType":null,"isESMImport":false,"locs":[{"start":{"line":10,"column":30,"index":275},"end":{"line":10,"column":69,"index":314}}],"key":"3tZGPFmYY28kUlEJgxUGaOwASzE=","exportNames":["*"],"imports":1}}],"output":[{"data":{"code":"__d(function (global, require, _$$_IMPORT_DEFAULT, _$$_IMPORT_ALL, module, exports, _dependencyMap) {\n  \"use strict\";\n\n  Object.defineProperty(exports, \"__esModule\", {\n    value: true\n  });\n  exports.TrezorConnectDynamic = void 0;\n  const utils_1 = require(_dependencyMap[0], \"@trezor/utils\");\n  const constants_1 = require(_dependencyMap[1], \"../constants\");\n  const events_1 = require(_dependencyMap[2], \"../events\");\n  const proxy_event_emitter_1 = require(_dependencyMap[3], \"../utils/proxy-event-emitter\");\n  class TrezorConnectDynamic {\n    callPending = 0;\n    beforeCallSynchronize = (0, utils_1.getSynchronize)();\n    constructor({\n      implementations,\n      getInitTarget,\n      handleBeforeCall,\n      handleErrorFallback\n    }) {\n      this.implementations = implementations;\n      this.currentTarget = this.implementations[0].type;\n      this.getInitTarget = getInitTarget;\n      this.handleBeforeCall = handleBeforeCall;\n      this.handleErrorFallback = handleErrorFallback;\n      this.eventEmitter = new proxy_event_emitter_1.ProxyEventEmitter(this.implementations.map(impl => impl.impl.eventEmitter));\n    }\n    getTarget() {\n      return this.implementations.find(impl => impl.type === this.currentTarget).impl;\n    }\n    getTargetType() {\n      return this.currentTarget;\n    }\n    async switchTarget(target) {\n      if (this.currentTarget === target) {\n        return;\n      }\n      if (!this.lastSettings) {\n        throw constants_1.ERRORS.TypedError('Init_ManifestMissing');\n      }\n      const oldTargetType = this.getTargetType();\n      const oldTarget = this.getTarget();\n      try {\n        this.currentTarget = target;\n        await this.getTarget().init(this.lastSettings);\n        await oldTarget.dispose();\n      } catch {\n        this.currentTarget = oldTargetType;\n      }\n    }\n    manifest(manifest) {\n      this.lastSettings = {\n        ...this.lastSettings,\n        manifest\n      };\n      this.getTarget().manifest(manifest);\n    }\n    async init(settings) {\n      if (!settings?.manifest) {\n        throw constants_1.ERRORS.TypedError('Init_ManifestMissing');\n      }\n      this.lastSettings = settings;\n      this.currentTarget = this.getInitTarget(settings);\n      this.callPending = 0;\n      try {\n        return await this.getTarget().init(this.lastSettings);\n      } catch (error) {\n        if (await this.handleErrorFallback(error.code)) {\n          return;\n        }\n        throw error;\n      }\n    }\n    setTransports({\n      transports\n    }) {\n      this.lastSettings = {\n        ...this.lastSettings,\n        transports\n      };\n      this.getTarget().setTransports({\n        transports\n      });\n    }\n    async call(params) {\n      try {\n        if (this.callPending === 0) {\n          await this.beforeCallSynchronize(async () => {\n            this.callPending++;\n            await this.handleBeforeCall();\n          });\n        }\n        const response = await this.getTarget().call(params);\n        if (!response.success) {\n          if (await this.handleErrorFallback(response.payload.code)) {\n            return await this.getTarget().call(params);\n          }\n        }\n        return response;\n      } catch (error) {\n        return (0, events_1.createErrorMessage)(error);\n      } finally {\n        this.callPending--;\n      }\n    }\n    uiResponse(params) {\n      return this.getTarget().uiResponse(params);\n    }\n    cancel(error) {\n      return this.getTarget().cancel(error);\n    }\n    dispose() {\n      this.eventEmitter.removeAllListeners();\n      this.callPending = 0;\n      return this.getTarget().dispose();\n    }\n  }\n  exports.TrezorConnectDynamic = TrezorConnectDynamic;\n});","lineCount":119,"map":[[2,2,1,0],[2,14,1,12],[4,2,3,0,"Object"],[4,8,3,6],[4,9,3,7,"defineProperty"],[4,23,3,21],[4,24,3,22,"exports"],[4,31,3,29],[4,33,3,31],[4,45,3,43],[4,47,3,45],[5,4,4,2,"value"],[5,9,4,7],[5,11,4,9],[6,2,5,0],[6,3,5,1],[6,4,5,2],[7,2,6,0,"exports"],[7,9,6,7],[7,10,6,8,"TrezorConnectDynamic"],[7,30,6,28],[7,33,6,31],[7,38,6,36],[7,39,6,37],[8,2,7,0],[8,8,7,6,"utils_1"],[8,15,7,13],[8,18,7,16,"require"],[8,25,7,23],[8,26,7,23,"_dependencyMap"],[8,40,7,23],[8,60,7,39],[8,61,7,40],[9,2,8,0],[9,8,8,6,"constants_1"],[9,19,8,17],[9,22,8,20,"require"],[9,29,8,27],[9,30,8,27,"_dependencyMap"],[9,44,8,27],[9,63,8,42],[9,64,8,43],[10,2,9,0],[10,8,9,6,"events_1"],[10,16,9,14],[10,19,9,17,"require"],[10,26,9,24],[10,27,9,24,"_dependencyMap"],[10,41,9,24],[10,57,9,36],[10,58,9,37],[11,2,10,0],[11,8,10,6,"proxy_event_emitter_1"],[11,29,10,27],[11,32,10,30,"require"],[11,39,10,37],[11,40,10,37,"_dependencyMap"],[11,54,10,37],[11,89,10,68],[11,90,10,69],[12,2,11,0],[12,8,11,6,"TrezorConnectDynamic"],[12,28,11,26],[12,29,11,27],[13,4,19,2,"callPending"],[13,15,19,13],[13,18,19,16],[13,19,19,17],[14,4,20,2,"beforeCallSynchronize"],[14,25,20,23],[14,28,20,26],[14,29,20,27],[14,30,20,28],[14,32,20,30,"utils_1"],[14,39,20,37],[14,40,20,38,"getSynchronize"],[14,54,20,52],[14,56,20,54],[14,57,20,55],[15,4,21,2,"constructor"],[15,15,21,13,"constructor"],[15,16,21,14],[16,6,22,4,"implementations"],[16,21,22,19],[17,6,23,4,"getInitTarget"],[17,19,23,17],[18,6,24,4,"handleBeforeCall"],[18,22,24,20],[19,6,25,4,"handleErrorFallback"],[20,4,26,2],[20,5,26,3],[20,7,26,5],[21,6,27,4],[21,10,27,8],[21,11,27,9,"implementations"],[21,26,27,24],[21,29,27,27,"implementations"],[21,44,27,42],[22,6,28,4],[22,10,28,8],[22,11,28,9,"currentTarget"],[22,24,28,22],[22,27,28,25],[22,31,28,29],[22,32,28,30,"implementations"],[22,47,28,45],[22,48,28,46],[22,49,28,47],[22,50,28,48],[22,51,28,49,"type"],[22,55,28,53],[23,6,29,4],[23,10,29,8],[23,11,29,9,"getInitTarget"],[23,24,29,22],[23,27,29,25,"getInitTarget"],[23,40,29,38],[24,6,30,4],[24,10,30,8],[24,11,30,9,"handleBeforeCall"],[24,27,30,25],[24,30,30,28,"handleBeforeCall"],[24,46,30,44],[25,6,31,4],[25,10,31,8],[25,11,31,9,"handleErrorFallback"],[25,30,31,28],[25,33,31,31,"handleErrorFallback"],[25,52,31,50],[26,6,32,4],[26,10,32,8],[26,11,32,9,"eventEmitter"],[26,23,32,21],[26,26,32,24],[26,30,32,28,"proxy_event_emitter_1"],[26,51,32,49],[26,52,32,50,"ProxyEventEmitter"],[26,69,32,67],[26,70,32,68],[26,74,32,72],[26,75,32,73,"implementations"],[26,90,32,88],[26,91,32,89,"map"],[26,94,32,92],[26,95,32,93,"impl"],[26,99,32,97],[26,103,32,101,"impl"],[26,107,32,105],[26,108,32,106,"impl"],[26,112,32,110],[26,113,32,111,"eventEmitter"],[26,125,32,123],[26,126,32,124],[26,127,32,125],[27,4,33,2],[28,4,34,2,"getTarget"],[28,13,34,11,"getTarget"],[28,14,34,11],[28,16,34,14],[29,6,35,4],[29,13,35,11],[29,17,35,15],[29,18,35,16,"implementations"],[29,33,35,31],[29,34,35,32,"find"],[29,38,35,36],[29,39,35,37,"impl"],[29,43,35,41],[29,47,35,45,"impl"],[29,51,35,49],[29,52,35,50,"type"],[29,56,35,54],[29,61,35,59],[29,65,35,63],[29,66,35,64,"currentTarget"],[29,79,35,77],[29,80,35,78],[29,81,35,79,"impl"],[29,85,35,83],[30,4,36,2],[31,4,37,2,"getTargetType"],[31,17,37,15,"getTargetType"],[31,18,37,15],[31,20,37,18],[32,6,38,4],[32,13,38,11],[32,17,38,15],[32,18,38,16,"currentTarget"],[32,31,38,29],[33,4,39,2],[34,4,40,2],[34,10,40,8,"switchTarget"],[34,22,40,20,"switchTarget"],[34,23,40,21,"target"],[34,29,40,27],[34,31,40,29],[35,6,41,4],[35,10,41,8],[35,14,41,12],[35,15,41,13,"currentTarget"],[35,28,41,26],[35,33,41,31,"target"],[35,39,41,37],[35,41,41,39],[36,8,42,6],[37,6,43,4],[38,6,44,4],[38,10,44,8],[38,11,44,9],[38,15,44,13],[38,16,44,14,"lastSettings"],[38,28,44,26],[38,30,44,28],[39,8,45,6],[39,14,45,12,"constants_1"],[39,25,45,23],[39,26,45,24,"ERRORS"],[39,32,45,30],[39,33,45,31,"TypedError"],[39,43,45,41],[39,44,45,42],[39,66,45,64],[39,67,45,65],[40,6,46,4],[41,6,47,4],[41,12,47,10,"oldTargetType"],[41,25,47,23],[41,28,47,26],[41,32,47,30],[41,33,47,31,"getTargetType"],[41,46,47,44],[41,47,47,45],[41,48,47,46],[42,6,48,4],[42,12,48,10,"oldTarget"],[42,21,48,19],[42,24,48,22],[42,28,48,26],[42,29,48,27,"getTarget"],[42,38,48,36],[42,39,48,37],[42,40,48,38],[43,6,49,4],[43,10,49,8],[44,8,50,6],[44,12,50,10],[44,13,50,11,"currentTarget"],[44,26,50,24],[44,29,50,27,"target"],[44,35,50,33],[45,8,51,6],[45,14,51,12],[45,18,51,16],[45,19,51,17,"getTarget"],[45,28,51,26],[45,29,51,27],[45,30,51,28],[45,31,51,29,"init"],[45,35,51,33],[45,36,51,34],[45,40,51,38],[45,41,51,39,"lastSettings"],[45,53,51,51],[45,54,51,52],[46,8,52,6],[46,14,52,12,"oldTarget"],[46,23,52,21],[46,24,52,22,"dispose"],[46,31,52,29],[46,32,52,30],[46,33,52,31],[47,6,53,4],[47,7,53,5],[47,8,53,6],[47,14,53,12],[48,8,54,6],[48,12,54,10],[48,13,54,11,"currentTarget"],[48,26,54,24],[48,29,54,27,"oldTargetType"],[48,42,54,40],[49,6,55,4],[50,4,56,2],[51,4,57,2,"manifest"],[51,12,57,10,"manifest"],[51,13,57,11,"manifest"],[51,21,57,19],[51,23,57,21],[52,6,58,4],[52,10,58,8],[52,11,58,9,"lastSettings"],[52,23,58,21],[52,26,58,24],[53,8,59,6],[53,11,59,9],[53,15,59,13],[53,16,59,14,"lastSettings"],[53,28,59,26],[54,8,60,6,"manifest"],[55,6,61,4],[55,7,61,5],[56,6,62,4],[56,10,62,8],[56,11,62,9,"getTarget"],[56,20,62,18],[56,21,62,19],[56,22,62,20],[56,23,62,21,"manifest"],[56,31,62,29],[56,32,62,30,"manifest"],[56,40,62,38],[56,41,62,39],[57,4,63,2],[58,4,64,2],[58,10,64,8,"init"],[58,14,64,12,"init"],[58,15,64,13,"settings"],[58,23,64,21],[58,25,64,23],[59,6,65,4],[59,10,65,8],[59,11,65,9,"settings"],[59,19,65,17],[59,21,65,19,"manifest"],[59,29,65,27],[59,31,65,29],[60,8,66,6],[60,14,66,12,"constants_1"],[60,25,66,23],[60,26,66,24,"ERRORS"],[60,32,66,30],[60,33,66,31,"TypedError"],[60,43,66,41],[60,44,66,42],[60,66,66,64],[60,67,66,65],[61,6,67,4],[62,6,68,4],[62,10,68,8],[62,11,68,9,"lastSettings"],[62,23,68,21],[62,26,68,24,"settings"],[62,34,68,32],[63,6,69,4],[63,10,69,8],[63,11,69,9,"currentTarget"],[63,24,69,22],[63,27,69,25],[63,31,69,29],[63,32,69,30,"getInitTarget"],[63,45,69,43],[63,46,69,44,"settings"],[63,54,69,52],[63,55,69,53],[64,6,70,4],[64,10,70,8],[64,11,70,9,"callPending"],[64,22,70,20],[64,25,70,23],[64,26,70,24],[65,6,71,4],[65,10,71,8],[66,8,72,6],[66,15,72,13],[66,21,72,19],[66,25,72,23],[66,26,72,24,"getTarget"],[66,35,72,33],[66,36,72,34],[66,37,72,35],[66,38,72,36,"init"],[66,42,72,40],[66,43,72,41],[66,47,72,45],[66,48,72,46,"lastSettings"],[66,60,72,58],[66,61,72,59],[67,6,73,4],[67,7,73,5],[67,8,73,6],[67,15,73,13,"error"],[67,20,73,18],[67,22,73,20],[68,8,74,6],[68,12,74,10],[68,18,74,16],[68,22,74,20],[68,23,74,21,"handleErrorFallback"],[68,42,74,40],[68,43,74,41,"error"],[68,48,74,46],[68,49,74,47,"code"],[68,53,74,51],[68,54,74,52],[68,56,74,54],[69,10,75,8],[70,8,76,6],[71,8,77,6],[71,14,77,12,"error"],[71,19,77,17],[72,6,78,4],[73,4,79,2],[74,4,80,2,"setTransports"],[74,17,80,15,"setTransports"],[74,18,80,16],[75,6,81,4,"transports"],[76,4,82,2],[76,5,82,3],[76,7,82,5],[77,6,83,4],[77,10,83,8],[77,11,83,9,"lastSettings"],[77,23,83,21],[77,26,83,24],[78,8,84,6],[78,11,84,9],[78,15,84,13],[78,16,84,14,"lastSettings"],[78,28,84,26],[79,8,85,6,"transports"],[80,6,86,4],[80,7,86,5],[81,6,87,4],[81,10,87,8],[81,11,87,9,"getTarget"],[81,20,87,18],[81,21,87,19],[81,22,87,20],[81,23,87,21,"setTransports"],[81,36,87,34],[81,37,87,35],[82,8,88,6,"transports"],[83,6,89,4],[83,7,89,5],[83,8,89,6],[84,4,90,2],[85,4,91,2],[85,10,91,8,"call"],[85,14,91,12,"call"],[85,15,91,13,"params"],[85,21,91,19],[85,23,91,21],[86,6,92,4],[86,10,92,8],[87,8,93,6],[87,12,93,10],[87,16,93,14],[87,17,93,15,"callPending"],[87,28,93,26],[87,33,93,31],[87,34,93,32],[87,36,93,34],[88,10,94,8],[88,16,94,14],[88,20,94,18],[88,21,94,19,"beforeCallSynchronize"],[88,42,94,40],[88,43,94,41],[88,55,94,53],[89,12,95,10],[89,16,95,14],[89,17,95,15,"callPending"],[89,28,95,26],[89,30,95,28],[90,12,96,10],[90,18,96,16],[90,22,96,20],[90,23,96,21,"handleBeforeCall"],[90,39,96,37],[90,40,96,38],[90,41,96,39],[91,10,97,8],[91,11,97,9],[91,12,97,10],[92,8,98,6],[93,8,99,6],[93,14,99,12,"response"],[93,22,99,20],[93,25,99,23],[93,31,99,29],[93,35,99,33],[93,36,99,34,"getTarget"],[93,45,99,43],[93,46,99,44],[93,47,99,45],[93,48,99,46,"call"],[93,52,99,50],[93,53,99,51,"params"],[93,59,99,57],[93,60,99,58],[94,8,100,6],[94,12,100,10],[94,13,100,11,"response"],[94,21,100,19],[94,22,100,20,"success"],[94,29,100,27],[94,31,100,29],[95,10,101,8],[95,14,101,12],[95,20,101,18],[95,24,101,22],[95,25,101,23,"handleErrorFallback"],[95,44,101,42],[95,45,101,43,"response"],[95,53,101,51],[95,54,101,52,"payload"],[95,61,101,59],[95,62,101,60,"code"],[95,66,101,64],[95,67,101,65],[95,69,101,67],[96,12,102,10],[96,19,102,17],[96,25,102,23],[96,29,102,27],[96,30,102,28,"getTarget"],[96,39,102,37],[96,40,102,38],[96,41,102,39],[96,42,102,40,"call"],[96,46,102,44],[96,47,102,45,"params"],[96,53,102,51],[96,54,102,52],[97,10,103,8],[98,8,104,6],[99,8,105,6],[99,15,105,13,"response"],[99,23,105,21],[100,6,106,4],[100,7,106,5],[100,8,106,6],[100,15,106,13,"error"],[100,20,106,18],[100,22,106,20],[101,8,107,6],[101,15,107,13],[101,16,107,14],[101,17,107,15],[101,19,107,17,"events_1"],[101,27,107,25],[101,28,107,26,"createErrorMessage"],[101,46,107,44],[101,48,107,46,"error"],[101,53,107,51],[101,54,107,52],[102,6,108,4],[102,7,108,5],[102,16,108,14],[103,8,109,6],[103,12,109,10],[103,13,109,11,"callPending"],[103,24,109,22],[103,26,109,24],[104,6,110,4],[105,4,111,2],[106,4,112,2,"uiResponse"],[106,14,112,12,"uiResponse"],[106,15,112,13,"params"],[106,21,112,19],[106,23,112,21],[107,6,113,4],[107,13,113,11],[107,17,113,15],[107,18,113,16,"getTarget"],[107,27,113,25],[107,28,113,26],[107,29,113,27],[107,30,113,28,"uiResponse"],[107,40,113,38],[107,41,113,39,"params"],[107,47,113,45],[107,48,113,46],[108,4,114,2],[109,4,115,2,"cancel"],[109,10,115,8,"cancel"],[109,11,115,9,"error"],[109,16,115,14],[109,18,115,16],[110,6,116,4],[110,13,116,11],[110,17,116,15],[110,18,116,16,"getTarget"],[110,27,116,25],[110,28,116,26],[110,29,116,27],[110,30,116,28,"cancel"],[110,36,116,34],[110,37,116,35,"error"],[110,42,116,40],[110,43,116,41],[111,4,117,2],[112,4,118,2,"dispose"],[112,11,118,9,"dispose"],[112,12,118,9],[112,14,118,12],[113,6,119,4],[113,10,119,8],[113,11,119,9,"eventEmitter"],[113,23,119,21],[113,24,119,22,"removeAllListeners"],[113,42,119,40],[113,43,119,41],[113,44,119,42],[114,6,120,4],[114,10,120,8],[114,11,120,9,"callPending"],[114,22,120,20],[114,25,120,23],[114,26,120,24],[115,6,121,4],[115,13,121,11],[115,17,121,15],[115,18,121,16,"getTarget"],[115,27,121,25],[115,28,121,26],[115,29,121,27],[115,30,121,28,"dispose"],[115,37,121,35],[115,38,121,36],[115,39,121,37],[116,4,122,2],[117,2,123,0],[118,2,124,0,"exports"],[118,9,124,7],[118,10,124,8,"TrezorConnectDynamic"],[118,30,124,28],[118,33,124,31,"TrezorConnectDynamic"],[118,53,124,51],[119,0,124,52],[119,3]],"functionMap":{"names":["<global>","TrezorConnectDynamic","TrezorConnectDynamic#constructor","implementations.map$argument_0","TrezorConnectDynamic#getTarget","implementations.find$argument_0","TrezorConnectDynamic#getTargetType","TrezorConnectDynamic#switchTarget","TrezorConnectDynamic#manifest","TrezorConnectDynamic#init","TrezorConnectDynamic#setTransports","TrezorConnectDynamic#call","beforeCallSynchronize$argument_0","TrezorConnectDynamic#uiResponse","TrezorConnectDynamic#cancel","TrezorConnectDynamic#dispose"],"mappings":"AAA;ACU;ECU;6FCW,8BD;GDC;EGC;qCCC,wCD;GHC;EKC;GLE;EMC;GNgB;EOC;GPM;EQC;GRe;ESC;GTU;EUC;yCCG;SDG;GVc;EYC;GZE;EaC;GbE;EcC;GdI;CDC"},"hasCjsExports":true},"type":"js/module"}]}